# 부록A 계약에 의한 설계

## 스터디 날짜
2022/02/21

### 계약에 의한 설계(Design By Contract, DBC)
협력에 필요한 다양한 제약과 부수효과를 명시적으로 정의하고 문서화할 수 있다.

## 1. 협력과 계약
### 계약
- 각 계약 당사자는 계약으로부터 **이익**을 기대하고 이익을 얻기 위한 **의무**를 이행한다.
- 이익과 의무는 계약서에 **문서화**된다.

## 2. 계약에 의한 설계
- 사전조건(precondition) : 메서드가 호출되기 위해 만족되어야 하는 조건. 사전조건을 만족시키는 것은 메서드를 실행하는 클라이언트의 의무다.
- 사후조건(postcondition) : 메서드가 실행된 후 클라이언트에게 보장해야 하는 조건. 사후조건을 만족시키는 것은 서버의 의무이다.
- 불변식(invariant) : 항상 참이라고 보장되는 서버의 조건.

### 사전조건
일반적으로 사전조건은 메서드에 절달된 인자의 정합성을 체크하기 위해 사용된다.

### 사후조건
메서드의 실행 결과가 올바른지를 검사하고 실행 후에 객체가 유효한 상태로 남아 있는지를 검증한다.
- 인스턴스 변수의 상태가 올바른지 서술하기 위해
- 메서드에 전달된 파라미터의 값이 올바르게 변경되었는지를 서술하기 위해
- 반환값이 올바른지를 서술하기 위해

두 가지 이유로 사후조건을 정의하는 것이 조금더 어렵다
- 한 메서드안에 여러 return 문이 나올때. return 마다 검증 코드 필요. 계약을 위한 라이브러리에서 대부분 제공
- 실행 전과 실행 후의 값을 비교하는 경우. 계약을 위한 라이브러리에서 대부분 제공

### 불변식
인스턴스 생명주기 전반에 걸쳐 지켜져야 하는 규칙. 객체의 내부 상태와 관련이 있다.
- 불변식은 클래스의 모든 인스턴스가 생성된 후에 만족되어야 한다.
- 호출 가능한 모든 메서드에 의해 준수되어야 한다. 메서드 실행 중에는 객체 상태가 불안정해질 수 있지만, 메서드 실행 전과 후는 항상 불변식을 만족해야한다.

## 3. 계약에 의한 설계와 서브타이핑
서브타입이 리스코프 치환 원칙을 만족시키기 위해 클라이언트와 슈퍼타입 간에 체결된 계약을 준수해야 한다.

### 계약 규칙 (contract rules)
- 서브타입에 더 강력한 사전조건을 정의할 수 없다.
- 서브타입에 더 완화된 사후조건을 정의할 수 없다.
- 슈퍼타입의 불변식은 서브타입에서도 반드시 유지되어야한다.

- *계약서에 명시된 의무보다 더 많은 의무를 짊어져서는 안된다.*
- *계약서에 명시된 이익보다 더 적게 받을 수 없다.*
- *변수 선언은 private 으로 하고 자식클래스가 접근하고 싶을때는 protect 메서드를 제공한다*

```java
protected void changeNext(RatePolicy next){
    this.next = next;
    // 불변식
    assert next != null;    
}
```

### 가변성 규칙 (variance rules)
- 서브타입의 메서드 파라미터는 반공변성을 가져야한다.
- 서브타입의 리턴 타입은 공변성을 가져야한다.
- 서브타입은 슈퍼타입이 발생시키는 예외와 다른 타입의 예외를 발생시켜서는 안 된다.

### 예외 발생
다른 타입의 예외 발생시 상속계층이 다르다면 catch 문으로 두 예외를 모두 처리할 수 없어 상위 클래스 예외는 예외처리에 잡히지 않는다.<br>
즉 서브타입이 아니다.

### 공변성 과 반공변성
공변성(covariance) : S T 사이에 서브타입 관계가 그대로 유지된다. 서브타입인 S 가 슈퍼타입인 T 대신 사용될 수 있다. 리스코프 치환 원칙과 관련<br>
반공변성(contravariance) : S T 사이에 서브타입 관계가 역전된다. 슈퍼타입인 T 가 서브타입인 S 대신 사용될 수 있다.<br>
무공변성(invariance) : S T 사이에 아무 관계도 없다. 두개 는 서로 사용 대체될 수 없다.<br>

![그림1](https://user-images.githubusercontent.com/71916223/154982187-58d81be6-00fd-42a5-8c27-1b093b13cf4e.PNG)

![그림2](https://user-images.githubusercontent.com/71916223/154982188-37dc48a0-d893-4124-8bf0-7f7c052319bf.PNG)

리턴타입 공변성(return type covariance) : 부모 클래스에서 구현된 메서드를 자식클래스에서 오버라이딩할 때 부모 클래스에서 선언한 반환타입의 서브타입으로 지정할 수 있는 특징


![그림3](https://user-images.githubusercontent.com/71916223/154982183-31831c2e-52e7-4b11-825a-fee1a0f5f2e2.PNG)

파라미터 타입 반공변성(parameter type contravariance) : 자식클래스에서 오버라이딩할 때 파라미터 타입을 부모 클래스에서 사용한 파라미터의 슈퍼타입으로 지정할 수 있는 특성


