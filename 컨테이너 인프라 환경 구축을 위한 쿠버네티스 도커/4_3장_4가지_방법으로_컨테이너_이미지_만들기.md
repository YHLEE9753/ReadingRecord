# 4.3장 4가지 방법으로 컨테이너 이미지 만들기

## 스터디 날짜
2022/03/14

1. 기본적인 빌드
2. 용량 줄이기
3. 컨테이너 내부 빌드
4. 멀티 스테이지

## 4.3.1 기본 방법으로 빌드하기
1. 자바 소스 빌드(java -> jar)
2. 도커파일 작성(Dockerfile)
3. 도커파일 빌드
4. 빌드 완료

```shell
# 자바 소스 코드를 실행 가능한 바이너리로 만들기 위해 자바 개발 도구 설치
yum install java-1.8.0-openjdk-devel -y 

# 메이븐은 빌드를 위한 의존성과 여러가지 설정을 자동화하는 도구이다. 빌드를 진행할 디렉터리를 비우고 JAR 생성하자
chmod 700 mvnw
./mvnw clean package

# 자바 빌드가 끝나고 JAR 파일이 생성된다.

# 컨테이너 이미지를 빌드하자(Dockerfile 이용)
docker build -t basic-img .

```

## 4.3.2 컨테이너 용량 줄이기
컨테이너 이미지의 용량을 줄여 빌드하자<br>
1. 도커 파일 작성
2. 도커 파일 빌드
3. 빌드 완료

빌드 과정이 ```build-in-host.sh``` 파일로 작성
Dockerfile 에서 기초 이미지가 openjdk 에서 경량화된 이미지로 변경된다.

## 4.3.3 컨테이너 내부에서 컨테이너 빌드하기
자바 소스를 컨테이너 이미지에서 빌드하자
1. 도커 파일 작성
2. 도커 파일 빌드
3. 빌드 완료

Dockerfile 확인시 소스 코드를 git 을 이용해 내려받고 ```build-in-host.sh``` 명령어를 RUN 을 이용해 추가한다.


## 4.3.4 최적화해 컨테이너 빌드하기
멀티 스테이지 빌드(Multi-Stage Build) 방법으로 최종 이미지의 용량을 줄이고 호스트에 어떠한 빌드 도구도 설치하지 않는다.
1. 도커 파일 작성
2. 도커 파일 빌드
3. 빌드 완료

멀티 스테이지 빌드는 docker-ce 19.09.0 이상에서만 가능<br>
멀티 스테이지의 핵심은 빌드하는 위치와 최종 이미지를 '분리' 하는 것이다. 최종 이미지는 빌드된 JAR 을 가지지만, 용량을 줄일 수 있다.<br>
<br>
Dockerfile 확인시 2개의 기초 이미지를 이용한다.<br>
1. FROM openjdk 에서 JAR 생성
2. FROM gcr.io/distroess/java:8 에서 빌드는 JAR 을 경량화 이미지에 복사한다.
3. 그 후 Dockerfile 을 이용해 컨테이너 이미지를 빌드한다.

<none> 이미지는 이름이 없는 댕글링<dangling> 이미지이다. 멀티 스테이지 과정에서 자바 소스를 빌드하는 과정에 생성된 이미지로 보인다.

```shell
docker rmi &(docker images -f dangling=true -q)
```





